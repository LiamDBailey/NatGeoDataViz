---
title: "NatGeoDataViz - Sankey Diagram"
author: "Liam Bailey, Kieran McHackermann & Cedric Scherer"
date: "June 3rd 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

```{r libraries, message = F}
library(tidyverse)
library(extrafont) ## only needed to change font - which do we pick? Any suggestions?
library(ggforce)
library(networkD3)
```


```{r data}
df_plastic <- readr::read_csv("https://raw.githubusercontent.com/LiamDBailey/NatGeoDataViz/master/inst/extdata/sectors_plastic.csv")
```

## Version using the `networkD3` package

```{r networkD3}
links <- as.data.frame(df_plastic) %>% 
  mutate(
    plastic = if_else(plastic == "Other", "Misc", plastic),  ## to avoid same name in both groups
    sectorID = as.numeric(as.factor(sector)) - 1,  ## ID needs to start with 0
    plasticID = as.numeric(as.factor(plastic)) + 6  ## to have unique IDs across groups
  )

nodes <- data.frame(name = c(sort(unique(links$sector)), sort(unique(links$plastic))))

nodes <- links %>% 
  arrange(sectorID, plasticID) %>% 
  dplyr::select(sector, plastic) %>% 
  unlist(use.names = F) %>% 
  unique() %>%
  as.tibble() %>% 
  rename(name = "value") %>%  ## sankeyNetwork only takes a data.frame with "name" as colname
  as.data.frame()

sankeyNetwork(Links = links, 
              Nodes = nodes, 
              Source = "sectorID",
              Target = "plasticID", 
              Value = "prop", 
              NodeID = "name", 
              sinksRight = FALSE)
```

## Version using `geom_parallel_sets`of the `ggforce` package

```{r ggforce, fig.width = 10, fig.height = 8}
df_plastic_sankey <- gather_set_data(df_plastic, 1:2)

## colored by sector
ggplot(df_plastic_sankey, aes(x, id = id, split = y, value = prop)) +
  geom_parallel_sets(aes(fill = sector), alpha = 0.3, axis.width = 0.1) +
  geom_parallel_sets_axes(fill = "transparent", axis.width = 0.5) +
  geom_parallel_sets_labels(colour = "black", family = "Poppins", 
                            size = 3, angle = 0, vjust = 0) +
  scale_fill_discrete(guide = F) + 
  coord_flip() + 
  theme_void() +
  theme(plot.margin = margin(0, 0, 0, 0))

## colored by plastic
ggplot(df_plastic_sankey, aes(x, id = id, split = y, value = prop)) +
  geom_parallel_sets(aes(fill = plastic), alpha = 0.3, axis.width = 0.1) +
  geom_parallel_sets_axes(fill = "transparent", axis.width = 0.5) +
  geom_parallel_sets_labels(colour = "black", family = "Poppins", 
                            size = 3, angle = 0, vjust = 0) +
  scale_fill_discrete(guide = F) + 
  coord_flip() + 
  theme_void() +
  theme(plot.margin = margin(0, 0, 0, 0))
```

Note: I was not able to switch the direction (upper and lower groups), sector always stays on top - I've tried 

* `gather_set_data(c(2,1))` instead of `gather_set_data(1:2)`
* `mutate(id = rev(id))` afterwards to let ID = 1 start with plastic not sector
* reversed the order of the `df_plastic_sankey` in general
* flip the coord in the other direction / several time (could not find if this is possible=

Groups could be aggregated to make it a bit more easy to read (but needs to be in line with the other vizes) - for example:

```{r, ggforce-lumped, fig.width = 10, fig.height = 8}
df_plastic %>% 
  mutate(sector = if_else(sector %in% c("Other", "Industrial machinery", "Electrical"), "Other", sector)) %>% 
  group_by(sector, plastic) %>% 
  summarize(prop = sum(prop)) %>% 
  gather_set_data(1:2) %>% 
  ggplot(aes(x, id = id, split = y, value = prop)) +
    geom_parallel_sets(aes(fill = sector), alpha = 0.3, axis.width = 0.1) +
    geom_parallel_sets_axes(fill = "transparent", axis.width = 0.5) +
    geom_parallel_sets_labels(colour = "black", family = "Poppins", 
                            size = 3, angle = 0, vjust = 0) +
    scale_fill_discrete(guide = F) + 
    coord_flip() + 
    theme_void() +
    theme(plot.margin = margin(0, 0, 0, 0))
```

***

```{r}
sessionInfo()
```

